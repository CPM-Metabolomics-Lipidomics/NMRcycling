---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


```{r setup}
library(AlpsNMR)
library(readxl)
library(prospectr)
library(factoextra)
```

```{r}
getwd()
datasetnames <- fs::dir_ls("../../NMRcycling_data/NMR/", glob="*")
datasetnames <- sapply(datasetnames, function(x) {file.path(paste(x, "10", sep="/"))})
```

```{r}
datasets <- nmr_read_samples(sample_names = datasetnames)
datasets <- nmr_interpolate_1D(datasets, axis = c(min = -0.5, max = 10, by = 2.3E-4))
plot(datasets, NMRExperiment = c("10...1", "10...2"))
```





```{r}
regions <- list(water = c(4.5, 5.0), upfield = c(-10, 0.5), downfield = c(10, 20))
datasets <- nmr_exclude_region(datasets, exclude = regions)
plot(datasets, NMRExperiment = c("10...1", "10...2"))
```
```{r}
datasets <- nmr_normalize(datasets, method = c("area"))
plot(datasets, NMRExperiment = c("10...1", "10...2"))
```
```{r}
datasets$data_1r <- binning(datasets$data_1r, bin.size=400)
datasets$axis <- binning(datasets$axis, bin.size=400)
plot(datasets, NMRExperiment = c("10...1", "10...2"))
```


```{r}
meta <- read_excel("../../NMRcycling/metadata/metadata.xlsx")
ds <- datasets
ds$metadata$external$path <- ds$metadata$info$info_sample_path
ds <- nmr_meta_add(ds, meta, by = c("path" = "Path"))
```


```{r}
groups <- ds$metadata$external$Phase
df <- ds$data_1r
rownames(df) <- ds$metadata$external$RowID
colnames(df) <- round(ds$axis,2)

df2 <- df[rownames(df) != "Pool",]
groups2 <- groups[groups != "Pool"]

for(i in 1:ncol(df2)) {
  df2[ ,i] <- (df2[ ,i] - mean(df2[ ,i])) / sqrt(sd(df2[ ,i]))
}

df2 <- df2 * 500.0

res <- (prcomp(df2))
fviz_pca_ind(res,
             axes = c(1,2),
             col.ind = groups2, # color by groups
             #palette = c("#00AFBB",  "#FC4E07", "#00AFBB",  "#FC4E07"),
             addEllipses = TRUE, # Concentration ellipses
             ellipse.type = "confidence",
             legend.title = "Groups",
             repel = TRUE
             )
```
```{r}
fviz_pca_biplot(res, repel = TRUE,
                axes = c(1,2),
                col.var = "contrib", # Variables color
                gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                select.var = list(contrib = 10)
                )
```
